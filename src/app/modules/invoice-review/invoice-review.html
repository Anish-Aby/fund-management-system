<div class="p-5">
  <div class="grid grid-cols-12">
    <div class="col-span-12 grid grid-cols-12 gap-4">
      <div class="col-span-7">
        <div
          class="border border-surface bg-primary-contrast rounded-2xl py-5 px-5 flex flex-col h-full"
        >
          <div class="flex w-full justify-between items-center">
            <div class="flex flex-col">
              @if (editMode()) {
              <p-button label="Save" severity="success" (onClick)="saveChanges()" size="small" />
              }
              <h1 class="text-4xl font-medium mb-1">Invoice Review</h1>
              <p class="text-sm text-muted-color mb-2">
                Review invoices, approve or reject them. Change tabs for viewing the invoices
              </p>
            </div>
            <p-select
              class="mb-4 max-w-60"
              [options]="invoiceOptions()"
              [ngModel]="selectedInvoiceId()"
              (ngModelChange)="onInvoiceSelect($event)"
              [filter]="true"
              [showClear]="true"
              placeholder="Select Invoice"
            />
          </div>
          <p-tabs [value]="selectedTabValue()" scrollable>
            <p-tablist>
              @for(invoice of invoiceData(); track invoice.invoiceNumber){
              <p-tab [value]="invoice.invoiceNumber">
                {{ invoice.invoiceNumber }}
              </p-tab>
              }
            </p-tablist>
            <p-tabpanels>
              @for(invoice of invoiceData(); track invoice.invoiceNumber){
              <p-tabpanel [value]="invoice.invoiceNumber">
                <div class="text-4xl grid grid-cols-2 py-2 font-medium">
                  <div class="col-span-1 flex items-center">
                    <div class="mr-6">
                      {{ invoice.invoicedFundName }}
                    </div>
                  </div>
                  <div class="col-span-1 flex justify-end text-primary">
                    <p-button
                      icon="pi pi-eye"
                      variant="outlined"
                      severity="contrast"
                      label="View Invoice PDF"
                      class="mr-2"
                    />
                  </div>
                </div>
                <div class="mb-6">
                  <div class="text-lg text-muted-color font-medium mb-2">
                    {{ invoice.invoiceNumber }}
                  </div>
                  <p-tag
                    class="h-max capitalize"
                    [value]="invoice.invoiceStatus"
                    [severity]="utilityService.getSeverity(invoice.invoiceStatus)"
                  />
                </div>

                @for (group of fieldGroups(); track group.name) {
                <div class="mb-4 border border-surface rounded-xl">
                  <div class="bg-slate-100 rounded-xl rounded-b-none shadow-sm">
                    <div class="text-xl font-medium pl-4 pt-2">{{ group.name }}</div>
                    <p-divider styleClass="mt-2!" />
                  </div>

                  <div class="grid grid-cols-12 gap-3 mt-4 px-4 pb-2">
                    @for (field of group.fields; track field.key) {
                    <div class="col-span-12 lg:col-span-4 xl:col-span-3">
                      <div class="text-muted-color uppercase text-xs mb-1">{{ field.label }}</div>

                      <!-- View Mode -->
                      @if (!editMode()) {
                      <div class="font-medium">
                        @if (field.type === 'currency') {
                        <span>
                          {{
                            formatCurrency(
                              getFieldValue(invoice, field.key),
                              invoice.vendorCurrency
                            )
                          }}
                        </span>
                        } @else {
                        <span>
                          {{ getFieldValue(invoice, field.key) }}
                        </span>
                        }
                      </div>
                      }

                      <!-- Edit Mode -->
                      @if (editMode() && field.editable) {
                      <div>
                        @if (field.type === 'text') {
                        <input
                          pInputText
                          class="w-full"
                          [ngModel]="getFieldValue(invoice, field.key)"
                          (ngModelChange)="invoice[field.key] = $event"
                        />
                        } @if (field.type === 'number' || field.type === 'currency') {
                        <p-inputNumber
                          class="w-full"
                          [ngModel]="getFieldValue(invoice, field.key)"
                          (ngModelChange)="invoice[field.key] = $event"
                          [minFractionDigits]="field.type === 'currency' ? 2 : 0"
                          [maxFractionDigits]="field.type === 'currency' ? 2 : 4"
                        />
                        } @if (field.type === 'date') {
                        <p-calendar
                          class="w-full"
                          [ngModel]="getFieldValue(invoice, field.key)"
                          (ngModelChange)="invoice[field.key] = $event"
                          dateFormat="yy-mm-dd"
                        />
                        } @if (field.type === 'textarea') {
                        <textarea
                          pInputTextarea
                          class="w-full"
                          rows="2"
                          [ngModel]="getFieldValue(invoice, field.key)"
                          (ngModelChange)="invoice[field.key] = $event"
                        >
                        </textarea>
                        }
                      </div>
                      }

                      <!-- Non-editable in edit mode -->
                      @if (editMode() && !field.editable) {
                      <div class="font-medium text-muted-color">
                        {{ getFieldValue(invoice, field.key) }}
                      </div>
                      }
                    </div>
                    }
                  </div>
                </div>
                }
                <div class="flex justify-between">
                  <p-button
                    icon="pi pi-times-circle"
                    severity="danger"
                    label="Reject Invoice"
                    class="mr-2"
                    (onClick)="showApproveDialog(invoice, 'reject')"
                  />
                  <p-button
                    icon="pi pi-check-circle"
                    severity="success"
                    label="Approve Invoice"
                    class="mr-2"
                    (onClick)="showApproveDialog(invoice, 'approve')"
                  />
                </div>
              </p-tabpanel>
              }
            </p-tabpanels>
          </p-tabs>
        </div>
      </div>
      <div class="col-span-5 max-h-[90dvh] sticky top-2">
        <div
          class="border border-surface bg-primary-contrast rounded-2xl py-5 px-5 flex flex-col h-full"
        >
          <div class="flex flex-col">
            <h1 class="text-4xl font-medium mb-1">Invoice PDF View</h1>
            <p class="text-sm text-muted-color mb-2">Review the invoice PDF here</p>
          </div>
          <div class="h-full">
            <ngx-extended-pdf-viewer
              [src]="'assets/sample-invoice.pdf'"
              [height]="'100%'"
              [textLayer]="true"
              [showSecondaryToolbarButton]="false"
              [showDownloadButton]="false"
              [showPrintButton]="false"
              [showOpenFileButton]="false"
              [zoom]="'page-width'"
              [showDrawEditor]="true"
              [showTextEditor]="true"
              [showHighlightEditor]="true"
            ></ngx-extended-pdf-viewer>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<p-dialog [modal]="true" [visible]="confirmDialogVisible()">
  <ng-template #headless>
    <div class="min-w-150">
      <div class="py-3 shadow-3xl px-3 flex justify-between items-center border-b border-surface">
        <span class="text-2xl font-semibold">
          @if (reviewConfirmType() === 'approve') { Approve Invoice } @else { Reject Invoice }
        </span>
        <p-button
          (onClick)="cancelApproveDialog()"
          icon="pi pi-times"
          size="small"
          variant="outlined"
          severity="contrast"
        />
      </div>
      <div class="">
        <div
          [ngClass]="{
            'bg-emerald-100': reviewConfirmType() === 'approve',
            'bg-red-100': reviewConfirmType() === 'reject'
          }"
          class="px-3 py-3 flex items-center"
        >
          <div
            [ngClass]="{
              'text-emerald-600 pi-verified': reviewConfirmType() === 'approve',
              'text-red-600 pi-times-circle': reviewConfirmType() === 'reject'
            }"
            class="pi mr-4 text-5xl!"
          ></div>
          @if (reviewConfirmType() === 'approve') {
          <div class="font-semibold">
            Are you sure you want to approve {{ invoiceToApprove().invoiceNumber }}
          </div>
          } @else {
          <div class="font-semibold">
            Are you sure you want to reject {{ invoiceToApprove().invoiceNumber }}
          </div>
          }
        </div>
      </div>
      <div class="px-3">
        <div class="mt-4 text-muted-color mb-1">Please provide your comments below</div>
        <textarea fluid rows="5" cols="30" pTextarea></textarea>
      </div>
      <div class="mt-4 px-3 py-2">
        <div class="flex justify-between">
          <p-button
            icon="pi pi-times-circle"
            variant="outlined"
            severity="contrast"
            label="Cancel"
            (onClick)="cancelApproveDialog()"
          />
          @if (reviewConfirmType() === 'approve') {
          <p-button
            (onClick)="approveInvoice()"
            icon="pi pi-check-circle"
            severity="contrast"
            label="Approve"
          />
          } @if (reviewConfirmType() === 'reject') {
          <p-button
            (onClick)="rejectInvoice()"
            icon="pi pi-times-circle"
            severity="contrast"
            label="Reject"
          />
          }
        </div>
      </div>
    </div>
  </ng-template>
</p-dialog>
